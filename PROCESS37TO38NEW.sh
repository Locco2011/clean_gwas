#!/bin/bash

# =================================================================================
# Bash è„šæœ¬: æ‰¹é‡è¿è¡ŒGWASæ•°æ®å¤„ç†Rè„šæœ¬
#
# åŠŸèƒ½:
#   - éå†æŒ‡å®šè¾“å…¥ç›®å½•ä¸­çš„æ‰€æœ‰ .txt æ–‡ä»¶ã€‚
#   - ä¸ºæ¯ä¸ªæ–‡ä»¶è°ƒç”¨ process_gwas_auto_name.R è„šæœ¬è¿›è¡Œå¤„ç†ã€‚
#   - å°†æ‰€æœ‰ç”Ÿæˆçš„ç»“æœæ–‡ä»¶ç§»åŠ¨åˆ°ä¸€ä¸ªå›ºå®šçš„è¾“å‡ºç›®å½•ä¸­ã€‚
#
# å¦‚ä½•ä½¿ç”¨:
#   1. å°†æ­¤è„šæœ¬ä¸ process_gwas_auto_name.R æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚
#   2. èµ‹äºˆæ­¤è„šæœ¬æ‰§è¡Œæƒé™: chmod +x batch_process.sh
#   3. è¿è¡Œè„šæœ¬ï¼Œå¹¶æä¾›åŒ…å«æºæ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„ä½œä¸ºå‚æ•°:
#      ./batch_process.sh /path/to/your/source_files
# =================================================================================

# --- é…ç½®åŒº ---

# è®¾ç½®å›ºå®šçš„è¾“å‡ºç›®å½• (è¯·æ ¹æ®æ‚¨çš„å®é™…æƒ…å†µä¿®æ”¹ "xxx/xx/xx/" éƒ¨åˆ†)
# ä¾‹å¦‚: OUTPUT_DIR="/home/user/my_project/processed_data"
OUTPUT_DIR="xxx/xx/xx/Process"

# Rè„šæœ¬çš„è·¯å¾„ (å‡è®¾å®ƒä¸æœ¬bashè„šæœ¬åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹)
# SCRIPT_DIR è·å–å½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
R_SCRIPT_PATH="${SCRIPT_DIR}/process_gwas_auto_name.R"


# --- è„šæœ¬ä¸»ä½“ ---

# æ£€æŸ¥æ˜¯å¦æä¾›äº†è¾“å…¥ç›®å½•å‚æ•°
if [ "$#" -ne 1 ]; then
    echo "ç”¨æ³•é”™è¯¯!"
    echo "è¯·æä¾›ä¸€ä¸ªæºæ–‡ä»¶ç›®å½•ä½œä¸ºå‚æ•°: $0 <source_directory>"
    exit 1
fi

SOURCE_DIR="$1"

# æ£€æŸ¥Rè„šæœ¬æ˜¯å¦å­˜åœ¨
if [ ! -f "$R_SCRIPT_PATH" ]; then
    echo "é”™è¯¯: Rè„šæœ¬æœªæ‰¾åˆ°! è¯·ç¡®ä¿ '$R_SCRIPT_PATH' å­˜åœ¨ã€‚"
    exit 1
fi

# æ£€æŸ¥æºç›®å½•æ˜¯å¦å­˜åœ¨
if [ ! -d "$SOURCE_DIR" ]; then
    echo "é”™è¯¯: æºç›®å½• '$SOURCE_DIR' ä¸å­˜åœ¨ã€‚"
    exit 1
fi

# æ£€æŸ¥å¹¶åˆ›å»ºè¾“å‡ºç›®å½•
if [ ! -d "$OUTPUT_DIR" ]; then
    echo "è¾“å‡ºç›®å½• '$OUTPUT_DIR' ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
    mkdir -p "$OUTPUT_DIR"
    echo "ç›®å½•åˆ›å»ºæˆåŠŸã€‚"
fi

echo "--------------------------------------------------"
echo "å¼€å§‹æ‰¹é‡å¤„ç†..."
echo "æºæ–‡ä»¶ç›®å½•: $SOURCE_DIR"
echo "ç»“æœè¾“å‡ºç›®å½•: $OUTPUT_DIR"
echo "ä½¿ç”¨çš„Rè„šæœ¬: $R_SCRIPT_PATH"
echo "--------------------------------------------------"

# æŸ¥æ‰¾å¹¶éå†æºç›®å½•ä¸­æ‰€æœ‰çš„ .txt æ–‡ä»¶
# ä½¿ç”¨ find å‘½ä»¤å¯ä»¥æ›´å¥½åœ°å¤„ç†åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ–‡ä»¶å
find "$SOURCE_DIR" -maxdepth 1 -type f -name "*.txt" | while read -r input_file; do

    echo "â–¶ æ­£åœ¨å¤„ç†æ–‡ä»¶: $(basename "$input_file")"

    # æ‰§è¡ŒRè„šæœ¬
    # Rè„šæœ¬ä¼šåœ¨å½“å‰å·¥ä½œç›®å½•ä¸‹ç”Ÿæˆç»“æœæ–‡ä»¶
    Rscript "$R_SCRIPT_PATH" "$input_file"

    # æ ¹æ®Rè„šæœ¬çš„é€»è¾‘ï¼Œæ¨æ–­å‡ºç”Ÿæˆçš„ç»“æœæ–‡ä»¶å
    # ä¾‹å¦‚: /path/to/file.txt -> file_hg19.txt
    base_name=$(basename "$input_file" .txt)
    generated_output_file="${base_name}_hg19.txt"

    # æ£€æŸ¥ç»“æœæ–‡ä»¶æ˜¯å¦æˆåŠŸç”Ÿæˆ
    if [ -f "$generated_output_file" ]; then
        # å¦‚æœæˆåŠŸï¼Œå°†å…¶ç§»åŠ¨åˆ°è¾“å‡ºç›®å½•
        mv "$generated_output_file" "$OUTPUT_DIR/"
        echo "âœ” å¤„ç†æˆåŠŸ! ç»“æœå·²ä¿å­˜è‡³: $OUTPUT_DIR/$(basename "$generated_output_file")"
    else
        echo "âŒ é”™è¯¯: Rè„šæœ¬æ‰§è¡Œåæœªæ‰¾åˆ°é¢„æœŸçš„è¾“å‡ºæ–‡ä»¶ '$generated_output_file'ã€‚"
        echo "   è¯·æ£€æŸ¥Rè„šæœ¬çš„è¾“å‡ºæˆ–å¯èƒ½çš„é”™è¯¯ä¿¡æ¯ã€‚"
    fi
    echo "--------------------------------------------------"

done

echo "ğŸ‰ å…¨éƒ¨å¤„ç†å®Œæˆ!"
